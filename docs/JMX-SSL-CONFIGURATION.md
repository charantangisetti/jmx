# Kafka JMX SSL Configuration Guide

This guide explains how to secure JMX endpoints in the Kafka cluster with SSL/TLS to address JMX vulnerabilities.

## Overview

By default, JMX endpoints in Kafka are exposed without encryption, which poses a security risk. This configuration adds SSL/TLS encryption and client certificate authentication to secure JMX access.

## Prerequisites

- OpenSSL installed
- Java keytool available
- kubectl access to the Kubernetes cluster
- Helm 3.x

## Step 1: Generate SSL Certificates

Run the certificate generation script:

```bash
./scripts/generate-jmx-certificates.sh
```

This script will:
- Generate a CA certificate
- Create server keystores and truststores for Kafka and Zookeeper
- Generate client certificates for JMX access
- Output the necessary commands to create Kubernetes secrets

## Step 2: Configure Values

### Option A: Using Kubernetes Secrets (Recommended)

1. Create the secrets as shown by the script output:

```bash
kubectl create secret generic kafka-jmx-certs -n <namespace> \
  --from-file=jmx-keystore.jks=<path>/jmx-keystore.jks \
  --from-file=jmx-truststore.jks=<path>/jmx-truststore.jks

kubectl create secret generic kafka-jmx-passwords -n <namespace> \
  --from-literal=JMX_KEYSTORE_PASSWORD=<keystore-password> \
  --from-literal=JMX_TRUSTSTORE_PASSWORD=<truststore-password>
```

2. Update your Helm values to reference the certificates:

```yaml
jmxCertificates:
  keystore: "base64-encoded-keystore-content"
  truststore: "base64-encoded-truststore-content"

jmxPasswords:
  keystorePassword: "your-keystore-password"
  truststorePassword: "your-truststore-password"
```

### Option B: Using Helm Values

Add the base64-encoded certificates directly to your values file:

```yaml
jmxCertificates:
  keystore: "<base64-encoded-keystore>"
  truststore: "<base64-encoded-truststore>"

jmxPasswords:
  keystorePassword: "your-keystore-password"
  truststorePassword: "your-truststore-password"
```

## Step 3: Deploy the Configuration

Deploy or upgrade your Kafka cluster:

```bash
helm upgrade --install kafkacluster ./charts/kafkacluster -f values.yaml
```

## Step 4: Verify JMX SSL Configuration

1. Check that the pods have the JMX SSL properties:

```bash
kubectl exec -it <kafka-pod> -- env | grep -E "JMX|SSL"
```

2. Verify JMX port is listening with SSL:

```bash
kubectl exec -it <kafka-pod> -- netstat -tlnp | grep 9999
```

## Connecting to Secure JMX

To connect to the secure JMX endpoint, you'll need:

1. The client keystore generated by the script
2. The truststore containing the CA certificate
3. JMX connection string with SSL parameters

Example JConsole connection:

```bash
jconsole -J-Djavax.net.ssl.keyStore=jmx-client-keystore.jks \
         -J-Djavax.net.ssl.keyStorePassword=<password> \
         -J-Djavax.net.ssl.trustStore=jmx-truststore.jks \
         -J-Djavax.net.ssl.trustStorePassword=<password> \
         service:jmx:rmi:///jndi/rmi://<kafka-host>:9999/jmxrmi
```

## Security Considerations

1. **Certificate Rotation**: Regularly rotate certificates (default validity is 10 years)
2. **Password Management**: Store passwords securely in a secrets management system
3. **Network Policies**: Implement Kubernetes NetworkPolicies to restrict JMX access
4. **Monitoring**: Set up alerts for failed JMX authentication attempts

## Troubleshooting

### Common Issues

1. **Certificate Validation Errors**
   - Ensure the CA certificate is imported into both keystores and truststores
   - Verify certificate CN matches the hostname

2. **Connection Refused**
   - Check that the JMX port (9999 for Kafka, 9998 for Zookeeper) is accessible
   - Verify SSL is enabled in JVM options

3. **Authentication Failures**
   - Ensure client certificates are properly signed by the CA
   - Verify passwords are correctly set in environment variables

### Debug Commands

```bash
# Check JVM options
kubectl exec -it <pod> -- ps aux | grep java

# Test SSL connection
openssl s_client -connect <host>:9999 -cert jmx-client-cert.pem -key jmx-client-key.pem

# View certificate details
keytool -list -v -keystore jmx-keystore.jks -storepass <password>
```

## Additional Security Measures

1. **Prometheus Monitoring**: The configuration includes secure metrics export via JMX Exporter
2. **RBAC**: Implement Kubernetes RBAC to restrict access to JMX secrets
3. **Audit Logging**: Enable JMX audit logging in Kafka configuration

## References

- [Strimzi Documentation - JMX Options](https://strimzi.io/docs/operators/latest/using.html#con-jmx-options-deployment-configuration-kafka)
- [Kafka Security Documentation](https://kafka.apache.org/documentation/#security)
- [Java JMX Security](https://docs.oracle.com/javase/8/docs/technotes/guides/management/agent.html)